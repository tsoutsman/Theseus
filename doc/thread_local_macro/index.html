<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Provides a `thread_local!()` macro, a helper to instantiate lazily-initialized  thread-local storage (TLS) variables."><title>thread_local_macro - Rust</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/SourceSerif4-Regular-46f98efaafac5295.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/FiraSans-Regular-018c141bf0843ffd.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/FiraSans-Medium-8f9a781e4970d388.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/SourceCodePro-Regular-562dcc5011b6de7d.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/SourceSerif4-Bold-a2c9cd1067f8b328.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/SourceCodePro-Semibold-d899c5a5c4aeb14a.ttf.woff2"><link rel="stylesheet" href="../static.files/normalize-76eba96aa4d2e634.css"><link rel="stylesheet" href="../static.files/rustdoc-f40c346f39d9abc1.css" id="mainThemeStyle"><div id="rustdoc-vars" data-root-path="../" data-static-root-path="../static.files/" data-current-crate="thread_local_macro" data-themes="" data-resource-suffix="" data-rustdoc-version="1.72.0-nightly (065a1f5df 2023-06-21)" data-search-js="search-95c92dd01058facf.js" data-settings-js="settings-de11bff964e9d4e5.js" data-settings-css="settings-8c76f75bfb6bd192.css" data-theme-light-css="light-0f8c037637f9eb3e.css" data-theme-dark-css="dark-1097f8e92a01e3cf.css" data-theme-ayu-css="ayu-614652228113ac93.css" ></div><script src="../static.files/storage-62ce34ea385b278a.js"></script><script defer src="../crates.js"></script><script defer src="../static.files/main-190c35055d2a8300.js"></script><noscript><link rel="stylesheet" media="(prefers-color-scheme:light)" href="../static.files/light-0f8c037637f9eb3e.css"><link rel="stylesheet" media="(prefers-color-scheme:dark)" href="../static.files/dark-1097f8e92a01e3cf.css"><link rel="stylesheet" href="../static.files/noscript-13285aec31fa243e.css"></noscript><link rel="alternate icon" type="image/png" href="../static.files/favicon-16x16-8b506e7a72182f1c.png"><link rel="alternate icon" type="image/png" href="../static.files/favicon-32x32-422f7d1d52889060.png"><link rel="icon" type="image/svg+xml" href="../static.files/favicon-2c020d218678b618.svg"></head><body class="rustdoc mod crate"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle">&#9776;</button><a class="logo-container" href="../thread_local_macro/index.html"><img class="rust-logo" src="../static.files/rust-logo-151179464ae7ed46.svg" alt="logo"></a><h2></h2></nav><nav class="sidebar"><a class="logo-container" href="../thread_local_macro/index.html"><img class="rust-logo" src="../static.files/rust-logo-151179464ae7ed46.svg" alt="logo"></a><h2 class="location"><a href="#">Crate thread_local_macro</a></h2><div class="sidebar-elems"><ul class="block"><li class="version">Version 0.1.0</li><li><a id="all-types" href="all.html">All Items</a></li></ul><section><ul class="block"><li><a href="#macros">Macros</a></li><li><a href="#structs">Structs</a></li></ul></section></div></nav><main><div class="width-limiter"><nav class="sub"><form class="search-form"><span></span><input class="search-input" name="search" aria-label="Run search in the documentation" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"><div id="help-button" title="help" tabindex="-1"><a href="../help.html">?</a></div><div id="settings-menu" tabindex="-1"><a href="../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../static.files/wheel-7b819b6101059cd0.svg"></a></div></form></nav><section id="main-content" class="content"><div class="main-heading"><h1>Crate <a class="mod" href="#">thread_local_macro</a><button id="copy-path" title="Copy item path to clipboard"><img src="../static.files/clipboard-7571035ce49a181d.svg" width="19" height="18" alt="Copy item path"></button></h1><span class="out-of-band"><a class="srclink" href="../src/thread_local_macro/lib.rs.html#1-614">source</a> · <button id="toggle-all-docs" title="collapse all docs">[<span>&#x2212;</span>]</button></span></div><details class="toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>Provides a <code>thread_local!()</code> macro, a helper to instantiate lazily-initialized 
thread-local storage (TLS) variables.</p>
<p>The primary difference between using this crate’s <code>thread_local!()</code> macro
and directly using the <code>#[thread_local]</code> attribute is that <code>static</code> items
tagged with the <code>#[thread_local]</code> attribute will <em>never</em> be dropped,
just like all other <code>static</code>s.</p>
<p>However, static items defined in a <code>thread_local!()</code> macro block will be
destructed (e.g., dropped, destroyed) when that task exits.</p>
<h2 id="rust-std-based-implementation-notes"><a href="#rust-std-based-implementation-notes">Rust std-based implementation notes</a></h2>
<p>The code in this crate is adapted from <a href="https://github.com/rust-lang/rust/blob/3f14f4b3cec811017079564e16a92a1dc9870f41/library/std/src/thread/local.rs">this version of the <code>thread_local!()</code> macro</a>
from the Rust standard library.
The main design has been left unchanged, but we have removed most of the configuration blocks
for complex platform-specific or OS-specific behavior.
Because Theseus supports the <code>#[thread_local]</code> attribute, we can directly use the 
TLS “fast path”, which the Rust standard library refers to as the “FastLocalInnerKey”.</p>
<h3 id="unsafety"><a href="#unsafety">Unsafety</a></h3>
<p>We could probably could remove most of the unsafe code from this implementation,
because we don’t have to account for the various raw platform-specific interfaces 
or using raw libc types like the original Rust std implementation does.
However, I have chosen to leave the code as close as possible to the original 
Rust std implementation in order to make updates as easy as possible,
for if and when the Rust std version changes and we wish to track/merge in those changes.</p>
</div></details><h2 id="macros" class="small-section-header"><a href="#macros">Macros</a></h2><ul class="item-table"><li><div class="item-name"><a class="macro" href="macro.thread_local.html" title="macro thread_local_macro::thread_local">thread_local</a></div><div class="desc docblock-short">Declare a new thread local storage key of type <a href="struct.LocalKey.html" title="struct thread_local_macro::LocalKey"><code>LocalKey</code></a>.</div></li></ul><h2 id="structs" class="small-section-header"><a href="#structs">Structs</a></h2><ul class="item-table"><li><div class="item-name"><a class="struct" href="struct.AccessError.html" title="struct thread_local_macro::AccessError">AccessError</a></div><div class="desc docblock-short">An error returned by <a href="struct.LocalKey.html#method.try_with"><code>LocalKey::try_with</code></a>.</div></li><li><div class="item-name"><a class="struct" href="struct.LocalKey.html" title="struct thread_local_macro::LocalKey">LocalKey</a></div><div class="desc docblock-short">A thread-local storage key which owns its contents.</div></li></ul></section></div></main></body></html>