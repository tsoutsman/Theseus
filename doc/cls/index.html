<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="A library for defining CPU-local variables."><title>cls - Rust</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/SourceSerif4-Regular-46f98efaafac5295.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/FiraSans-Regular-018c141bf0843ffd.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/FiraSans-Medium-8f9a781e4970d388.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/SourceCodePro-Regular-562dcc5011b6de7d.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/SourceSerif4-Bold-a2c9cd1067f8b328.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/SourceCodePro-Semibold-d899c5a5c4aeb14a.ttf.woff2"><link rel="stylesheet" href="../static.files/normalize-76eba96aa4d2e634.css"><link rel="stylesheet" href="../static.files/rustdoc-9ee3a5e31a2afa3e.css"><meta name="rustdoc-vars" data-root-path="../" data-static-root-path="../static.files/" data-current-crate="cls" data-themes="" data-resource-suffix="" data-rustdoc-version="1.75.0-nightly (aa1a71e9e 2023-10-26)" data-channel="nightly" data-search-js="search-8fbf244ebcf71464.js" data-settings-js="settings-74424d7eec62a23e.js" ><script src="../static.files/storage-fec3eaa3851e447d.js"></script><script defer src="../crates.js"></script><script defer src="../static.files/main-5f34af1a0ee6bacd.js"></script><noscript><link rel="stylesheet" href="../static.files/noscript-5d8b3c7633ad77ba.css"></noscript><link rel="alternate icon" type="image/png" href="../static.files/favicon-16x16-8b506e7a72182f1c.png"><link rel="alternate icon" type="image/png" href="../static.files/favicon-32x32-422f7d1d52889060.png"><link rel="icon" type="image/svg+xml" href="../static.files/favicon-2c020d218678b618.svg"></head><body class="rustdoc mod crate"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle">&#9776;</button></nav><nav class="sidebar"><div class="sidebar-crate"><h2><a href="../cls/index.html">cls</a><span class="version">0.1.0</span></h2></div><div class="sidebar-elems"><ul class="block">
            <li><a id="all-types" href="all.html">All Items</a></li></ul><section><ul class="block"><li><a href="#traits">Traits</a></li><li><a href="#attributes">Attribute Macros</a></li></ul></section></div></nav><main><div class="width-limiter"><nav class="sub"><form class="search-form"><span></span><input class="search-input" name="search" aria-label="Run search in the documentation" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"><div id="help-button" title="help" tabindex="-1"><a href="../help.html">?</a></div><div id="settings-menu" tabindex="-1"><a href="../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../static.files/wheel-7b819b6101059cd0.svg"></a></div></form></nav><section id="main-content" class="content"><div class="main-heading"><h1>Crate <a class="mod" href="#">cls</a><button id="copy-path" title="Copy item path to clipboard"><img src="../static.files/clipboard-7571035ce49a181d.svg" width="19" height="18" alt="Copy item path"></button></h1><span class="out-of-band"><a class="src" href="../src/cls/lib.rs.html#1-153">source</a> · <button id="toggle-all-docs" title="collapse all docs">[<span>&#x2212;</span>]</button></span></div><details class="toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>A library for defining CPU-local variables.</p>
<p>See <a href="attr.cpu_local.html" title="attr cls::cpu_local"><code>cpu_local</code></a> for more details on how to define a CPU-local variable; the information below
is not required.</p>
<h2 id="implementation"><a href="#implementation">Implementation</a></h2>
<p>There are two ways in which a crate can be linked:</p>
<ul>
<li>Statically, meaning it is linked at compile-time by an external linker.</li>
<li>Dynamically, meaning it is linked at runtime by <code>mod_mgmt</code>.</li>
</ul>
<p>Since we have little control over the external linker, we are forced to write CLS code
that works with the external linker, despite the linker having no understanding of CLS.
This lack of understanding results in significant complexity in calculating the offset
of a CLS symbol.</p>
<p>Also there is no way to tell whether code was statically or dynamically linked, and so the same
CLS code must work with both static and dynamic linking. This results in additional complexity
in <code>mod_mgmt</code> because it must interface with this generic CLS code.</p>
<h3 id="x86-64"><a href="#x86-64">x86-64</a></h3><h4 id="static-linking"><a href="#static-linking">Static linking</a></h4>
<p>On x86_64, a TLS data image looks like</p>
<div class="example-wrap"><pre class="language-text"><code>                       fs
                        V
+-----------------------+--------------+------------------------+
| statically linked TLS | TLS self ptr | dynamically linked TLS |
+-----------------------+--------------+------------------------+
</code></pre></div>
<p>where statically linked TLS is accessed using a negative offset from the <code>fs</code>
register.</p>
<p>Now with the way CLS works on Theseus, when we statically link CLS, the
linker believes we are prepending the cls section to the tls section like</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code>                       gs                            fs
                        V                             V
+-----------------------+-----+-----------------------+
| statically linked cls | <span class="number">000 </span>| statically linked TLS |
+-----------------------+-----+-----------------------+</code></pre></div>
<p>where <code>000</code> are padding bytes to align the start of the statically linked
TLS to a page boundary. So the linker will write negative offsets to CLS
relocations based on their distance from the end of the statically linked
TLS.</p>
<p>However, in reality we have a completely separate data image for CLS, and
so we need to figure out the negative offset from the <code>gs</code> register based on
the negative offset from the <code>fs</code> register, the CLS size, the TLS size, and
the fact that the start of the TLS section is on the next page boundary after
the end of the CLS section.</p>
<div class="example-wrap"><pre class="language-text"><code>from_cls_start
   +-----+
   |     |
   |     |        -{cls}@TPOFF
   |     +------------------------------+
   |     |                              |
   |     |  -offset                     |
   |     +----------+                   |
   |     |          |                   |
   V     V          V                   V
   +----------------+-----+-------------+
   |      .cls      | 000 | .tls/.tdata |
   +----------------+-----+-------------+
   ^                ^     ^             ^
   |                |     |             |
   |                gs    |            fs
   |                |     |             |
   +----------------+     +-------------+
   |    cls_size          |   tls_size
   |                      |
  a*4kb                  b*4kb
   |                      |
   +----------------------+
    cls_start_to_tls_start
</code></pre></div>
<p>where <code>a*4kb</code> means that the address is a multiple of <code>4kb</code> i.e.
page-aligned.</p>
<h4 id="dynamic-linking"><a href="#dynamic-linking">Dynamic linking</a></h4>
<p>When a crate is dynamically linked on x86_64, <code>mod_mgmt</code> will set <code>__THESEUS_CLS_SIZE</code>
and <code>__THESEUS_TLS_SIZE</code> to <code>usize::MAX</code>. Prior to calculating the offset, the CLS
access code will check if the variables are set to their sentinel values and if so,
it will simply use the provided offset since <code>mod_mgmt</code> would have computed it
correctly, unlike the external linker.</p>
<h3 id="aarch64"><a href="#aarch64">aarch64</a></h3>
<p>Unlike x86_64, aarch64 doesn’t have different branches for statically linked, and
dynamically linked variables. This is because on aarch64, there are no negative
offset shenanigans. A TLS data image looks like</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code>fs
V
+-----------------------+------------------------+
| statically linked TLS | dynamically linked TLS |
+-----------------------+------------------------+</code></pre></div>
<p>Unlike x86_64, the <code>.cls</code> section is located after <code>.tls</code> in a binary and so the
linker thinks the data image looks like</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code>fs
V
+-----------------------+-----+-----------------------+------------------------+
| statically linked TLS | <span class="number">000 </span>| statically linked CLS | dynamically linked TLS |
+-----------------------+-----+-----------------------+------------------------+</code></pre></div>
<p>where <code>000</code> are padding bytes to align the start of the statically linked CLS to
a page boundary.</p>
<p>Hence, CLS symbols have an offset that is incorrect by
<code>tls_size.next_multiple_of(0x1000)</code>, or 0 if there is not TLS section. So, when
loading CLS symbols on aarch64, <code>mod_mgmt</code> simply sets <code>__THESEUS_TLS_SIZE</code> to 0.</p>
</div></details><h2 id="traits" class="small-section-header"><a href="#traits">Traits</a></h2><ul class="item-table"><li><div class="item-name"><a class="trait" href="trait.CpuAtomicGuard.html" title="trait cls::CpuAtomicGuard">CpuAtomicGuard</a></div><div class="desc docblock-short">A trait abstracting over guards that ensure atomicity with respect to the
current CPU.</div></li></ul><h2 id="attributes" class="small-section-header"><a href="#attributes">Attribute Macros</a></h2><ul class="item-table"><li><div class="item-name"><a class="attr" href="attr.cpu_local.html" title="attr cls::cpu_local">cpu_local</a></div><div class="desc docblock-short">A macro for declaring CPU-local variables.</div></li></ul></section></div></main></body></html>